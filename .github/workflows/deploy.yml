name: Deploy

on:
  push:
    branches: [ master ]
    paths-ignore:
      - README.md
      - doc/

concurrency: deploy

jobs:
  build:
    strategy:
      matrix:
        machine: [gateway, spum-platform , spum-mqtt , builder , grades, ps , esp, usatour, calendar, prometheus, bioma, gb , ears, collab]

    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2
    - uses: actions/checkout@v2
      with:
        repository: UM-LPM/known_hosts
        path: known_hosts
    - uses: cachix/install-nix-action@v12
      with: 
        nix_path: nixpkgs=channel:nixos-21.05

    - name: Set known hosts
      run: install -D -m 400 known_hosts/known_hosts ~/.ssh/known_hosts
    
    - name: Deploy
      run: |
        eval "$(ssh-agent)"
        ssh-add - <<< "${{secrets.sshkey}}"
        cd machines
        ./deploy.sh ${{matrix.machine}
